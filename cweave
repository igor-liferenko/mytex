#!/bin/sh
file=$1
if [ "$2" = "" ]; then
  ch=/dev/null
else
  ch=$2.ch
fi
test -e $file.w || { echo '! Cannot open input file' $file.w; exit 1; }
test -e $ch || { echo '! Cannot open change file' $ch; exit 1; }
tmp=$file.cweave.$$
ctie -m $tmp $file.w $ch >/dev/null || { rm -f $tmp; exit 1; } # expand @i
grep '@s sigaction' $tmp && { echo ERROR: Use cyrillic a; rm $tmp; exit 1; }
grep 'struct sigaction' $tmp && { echo ERROR: Use cyrillic a; rm $tmp; exit 1; }
grep '@s stat' $tmp && { echo ERROR: Use cyrillic a; rm $tmp; exit 1; }
grep 'struct stat' $tmp && { echo ERROR: Use cyrillic a; rm $tmp; exit 1; }
rm $tmp
~/cweb/cweave -b -h -p "$@" || exit 1
grep -q -P '\\\|[^\x00-\x7F]' $file.tex && echo WARNING: one-letter identifiers must be ascii-only # I do not set \matcharcode for cyrillic letters (because I do not have cyrillic math fonts), so cyrillic one-letter identifiers will be typeset in roman font instead of italic
if [ $file != tel ] && sed 's/sig\xD0\xB0ction/sigaction/g;s/st\xD0\xB0t/stat/g;s/lin\xD0\xB5/line/g' $file.tex | grep -P '[^\x00-\x7F]' >/dev/null; then
  sed -i 1s/cwebmac/cwebmac-ru/ $file.tex
fi
sed -i 's/sig\xD0\xB0ction/sigaction/g' $file.tex $file.idx $file.scn
sed -i 's/st\xD0\xB0t/stat/g' $file.tex $file.idx $file.scn
sed -i 's/lin\xD0\xB5/line/g' $file.tex $file.idx $file.scn
