#!/bin/sh
export PKFONTS=$HOME/.PKfonts/$mode # used in MakePK and dvips (if you change here, change also in mf/Makefile)
mkdir /tmp/mf.$$
resolution=$(cd /tmp/mf.$$; mf "\mode=$mode; mode_setup; show pixels_per_inch; end" | sed -n 's/>> //p')
rm -r /tmp/mf.$$
file=${1##*/}
dvitype -output-level 0 $file | \
  sed -n '0,/^Postamble starts at byte/{s/^Font.*://;s/ scaled [0-9]\+//;s/---not loaded.*//p}' | \
  sort | uniq | while read REPLY; do ~/mytex/MakeTFM $REPLY || exit; done || exit
dvitype -output-level 0 $file | \
  sed -n 's/^Font [0-9]\+/ERROR/;s/ scaled [0-9]\+//;s/---beware.*/ --- check sum does not agree with TFM/p' | \
  sort | uniq | grep ^ && exit 1
dvitype -output-level 0 $file | \
  sed -n '/^Postamble starts at byte/,${s/^Font.*://p}' | \
  sed '/scaled/!s/$/ scaled 1000/' | sed s/scaled/$resolution/ | \
  while read REPLY; do ~/mytex/MakePK $REPLY || exit; done || exit
eval "$(hexdump -s15 -n `hexdump -s14 -n1 -e '"%u"' $file` -v -e '"%c"' $file | sed 's/.* /p=/;s/x/sp,/;s/[+-][0-9]*/sp x=& y=/')"
export TEXCONFIG=~/dvips
export DVIPSHEADERS=~/dvips
if   [ $p = 39158276sp,55380990sp ]; then p=a4
elif [ $p = 55380990sp,39158276sp ]; then p='a4 -t landscape'
elif [ $p = 39158272sp,55380987sp ]; then p=a4
elif [ $p = 39158275sp,55380990sp ]; then p=a4
elif [ $p = 39158274sp,55380990sp ]; then p=a4
elif [ $p = 39158273sp,55380989sp ]; then p=a4
elif [ $p = 39158268sp,55380987sp ]; then p=a4
elif [ $p = 39158271sp,55380986sp ]; then p=a4
else echo $p; exit 1; fi
~/dvips/dvips -t $p -O $((x-4736287))sp,$((y-4736287))sp -D $resolution -q $file
